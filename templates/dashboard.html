{% extends 'base.html' %}

{% block title %}Dashboard — Global Santé{% endblock %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script>
    window.GS_SERIES = {{ series|tojson }};
  </script>
{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12">
    <div class="gs-hero gs-glass">
      <img
        src="https://images.unsplash.com/photo-1527137342181-19aab11a8ee8?auto=format&fit=crop&w=1600&q=80"
        alt="A person journaling"
      />
      <div class="gs-hero-content">
        <div>
          <div class="h3 fw-bold mb-1">How are you today?</div>
          <div class="text-white-75">A quick check-in helps you notice patterns and care for yourself.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card gs-glass border-0">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h2 class="h5 fw-bold mb-1">Daily check-in</h2>
            <div class="text-white-75" style="font-size: .95rem;">Date: {{ today }}</div>
          </div>
          {% if user['is_premium'] %}
          <span class="badge bg-success">Premium</span>
          {% else %}
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('premium') }}">Go Premium</a>
          {% endif %}
        </div>

        <hr class="border-white border-opacity-10" />

        <form method="post" action="{{ url_for('checkin_post') }}">
          <div class="mb-3">
            <label class="form-label text-white-75" for="date">Date</label>
            <input class="form-control" type="date" id="date" name="date" value="{{ today }}" required />
          </div>

          <div class="mb-3">
            <label class="form-label text-white-75">Mood</label>
            <div class="d-flex gap-2 flex-wrap">
              {% for v in [1,2,3,4,5] %}
              <input class="btn-check" type="radio" name="mood" id="mood{{v}}" value="{{v}}" {% if existing_today and existing_today['mood']==v %}checked{% endif %} {% if not existing_today and v==3 %}checked{% endif %} required />
              <label class="btn btn-outline-light" for="mood{{v}}">{{v}}</label>
              {% endfor %}
            </div>
            <div class="text-white-50 mt-2" style="font-size: .9rem;">1 = very low, 5 = great</div>
          </div>

          <div class="mb-3" data-range>
            <label class="form-label text-white-75" for="stress">Stress (0–10) <span class="badge gs-badge" data-range-out></span></label>
            <input class="form-range" type="range" min="0" max="10" step="1" id="stress" name="stress" value="{{ existing_today['stress'] if existing_today else 5 }}" />
          </div>

          <div class="mb-3" data-range>
            <label class="form-label text-white-75" for="sleep">Sleep quality (0–10) <span class="badge gs-badge" data-range-out></span></label>
            <input class="form-range" type="range" min="0" max="10" step="1" id="sleep" name="sleep" value="{{ existing_today['sleep'] if existing_today else 5 }}" />
          </div>

          <div class="mb-3">
            <label class="form-label text-white-75" for="journal">Journal note (optional)</label>
            <textarea class="form-control" rows="5" id="journal" name="journal" placeholder="What’s on your mind today?">{{ existing_today['journal'] if existing_today else '' }}</textarea>
          </div>

          <button class="btn btn-gs w-100" type="submit">Save check-in</button>
        </form>
      </div>
    </div>

    <div class="card gs-glass border-0 mt-4">
      <div class="card-body p-4">
        <h3 class="h6 fw-bold">Motivation</h3>
        <div class="text-white-75">"Small steps count. Show up gently."</div>
        <div class="text-white-50 mt-1">— Global Santé</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-7">
    <div class="card gs-glass border-0">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h2 class="h5 fw-bold mb-1">Weekly trends</h2>
            <div class="text-white-75" style="font-size: .95rem;">Last 7 days (including today)</div>
          </div>
        </div>

        <div style="height: 280px;" class="mt-3">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card gs-glass border-0 mt-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h5 fw-bold mb-0">History</h2>
          <span class="text-white-50" style="font-size: .95rem;">Last 60 entries</span>
        </div>
        <hr class="border-white border-opacity-10" />

        <div class="table-responsive">
          <table class="table table-dark table-borderless align-middle mb-0" style="--bs-table-bg: transparent;">
            <thead>
              <tr class="text-white-50">
                <th>Date</th>
                <th>Mood</th>
                <th>Stress</th>
                <th>Sleep</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              {% for e in history %}
              <tr>
                <td class="fw-semibold">{{ e['date'] }}</td>
                <td>{{ e['mood'] }}</td>
                <td>{{ e['stress'] }}</td>
                <td>{{ e['sleep'] }}</td>
                <td class="text-white-75" style="max-width: 420px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ e['journal'] }}</td>
              </tr>
              {% endfor %}
              {% if history|length == 0 %}
              <tr>
                <td colspan="5" class="text-white-50">No entries yet. Add your first check-in.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='app.js') }}"></script>
{% endblock %}
